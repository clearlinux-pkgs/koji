Subject: [PATCH] Fix CVE-2018-1002150Â¶

From versions 1.12.0 to 1.15.0, the Koji hub did not perform proper access
checks for the hub.distRepoMove call. By passing carefully constructed
arguments to the call, an unauthenticated user can trick Koji into moving
content around that it should not. This could result in corrupting any files
that the httpd process can write to, or revealing any files that the httpd
process can read. If the user can authenticate (at any privilege level), then
they can use this mechanism to replace a file with one that they have uploaded.

https://docs.pagure.org/koji/CVE-2018-1002150/

---

diff --git a/hub/kojihub.py b/hub/kojihub.py
index 4e0e558..cd46fda 100644
--- a/hub/kojihub.py
+++ b/hub/kojihub.py
@@ -12517,6 +12517,8 @@ class HostExports(object):
         In sigmap, use sig=None to use the primary copy of the rpm instead of a
         signed copy.
         """
+        host = Host()
+        host.verify()
         workdir = koji.pathinfo.work()
         rinfo = repo_info(repo_id, strict=True)
         repodir = koji.pathinfo.distrepo(repo_id, rinfo['tag_name'])
diff --git a/koji/auth.py b/koji/auth.py
index 6f43159..f780cf6 100644
--- a/koji/auth.py
+++ b/koji/auth.py
@@ -71,6 +71,10 @@ class Session(object):
         self.exclusive = False
         self.lockerror = None
         self.callnum = None
+        # we look up perms, groups, and host_id on demand, see __getattr__
+        self._perms = None
+        self._groups = None
+        self._host_id = ''
         #get session data from request
         if args is None:
             environ = getattr(context, 'environ', {})
@@ -204,10 +208,6 @@ class Session(object):
         self.master = session_data['master']
         self.session_data = session_data
         self.user_data = user_data
-        # we look up perms, groups, and host_id on demand, see __getattr__
-        self._perms = None
-        self._groups = None
-        self._host_id = ''
         self.logged_in = True
 
     def __getattr__(self, name):

